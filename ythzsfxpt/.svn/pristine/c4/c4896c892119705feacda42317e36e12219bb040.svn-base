package com.inspur.controller;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.inspur.service.DtglService;
import com.inspur.service.DzjcService;
import com.inspur.service.TyslService;
import com.inspur.utils.TemplateExportExcelUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.ResourceUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.FileNotFoundException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/* 一窗受理controller
 * @author ly
 * @date 20191030
 *
 */
@RestController
@RequestMapping("/tyslcontroller")
public class TyslController {

    @Autowired
    private TyslService tyslService;

    @Autowired
    private DzjcService dzjcService;

    @Autowired
    private DtglService dtglService;


    @RequestMapping(value = "/tyslsum", method = RequestMethod.GET)
    public Map<String, Object> tyslsum() {
        Map<String, Object> map = new HashMap<String, Object>();
        int tyslsum = tyslService.getSum();
        System.out.println("tyslsum========" + tyslsum);
        map.put("tyslsum", tyslsum);
        return map;
    }

    /**
     * 获取每天的一窗受理数量
     *
     * @return
     */
    @RequestMapping(value = "/getycsjsl", method = RequestMethod.GET)
    public Map<String, Object> getycsjsl() {
        Map<String, Object> map = new HashMap<String, Object>();
        Date now = new Date();    //创建一个Date对象,获取当前时间
        //指定格式化格式
        SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");
        String Cdate = f.format(now);
        System.out.println("Cdate======" + Cdate);
        List<Map<String, Object>> ycsjsl = tyslService.getycsjsl(Cdate);
        System.out.println("ycsjsl========" + ycsjsl);
        int sum = 0;
        for (int i = 0; i < ycsjsl.size(); i++) {
            System.out.println(ycsjsl.get(i));
            sum += Integer.parseInt(ycsjsl.get(i).get("SUM").toString());
        }
        System.out.println("tyslsum========" + sum);
        map.put("ycsjsl", sum);
        return map;
    }

    /**
     * 获取一窗收件数量变化趋势
     *
     * @return
     */
    @RequestMapping(value = "/getycsjqs", method = RequestMethod.GET)
    public Map<String, Object> getycsjqs() {
        Map<String, Object> map = new HashMap<String, Object>();
        List<Map<String, Object>> list = tyslService.getycsjqs();
        System.out.println("tyslsum========" + list);
        map.put("ycsjqs", list);
        return map;
    }

    /**
     * 获取一窗收件事项列表
     *
     * @return
     */
    @RequestMapping(value = "/getycsjlb", method = RequestMethod.GET)
    public Map<String, Object> getycsjlb(@RequestParam(value = "page", required = true) int page) {
        Map<String, Object> map = new HashMap<String, Object>();
        Date now = new Date();    //创建一个Date对象,获取当前时间
        //指定格式化格式
        SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");
        String Cdate = f.format(now);
        System.out.println("Cdate======" + Cdate);
        List<Map<String, Object>> list = tyslService.getycsjlb(Cdate, page);
        System.out.println("ycsjlb========" + list);
        map.put("ycsjlb", list);
        return map;
    }

    /**
     * 下载一窗收件事项列表
     *
     * @return
     */
    @RequestMapping(value = "/downloadsxlb", method = RequestMethod.GET)
    public void downloadsxlb(HttpServletResponse response) {
        File file = null;
        try {
            file = ResourceUtils.getFile("classpath:static/excel/一窗事项列表.xlsx");
            Date now = new Date();    //创建一个Date对象,获取当前时间
            //指定格式化格式
            SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");
            String Cdate = f.format(now);
            //查询数据
            List<Map<String, Object>> list = tyslService.downloadsxlb(Cdate);
            // 往excel里写入数据
            TemplateExportExcelUtil.exportExcel(file, list, response);

        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
    }

    /**
     * 获取一窗收件事项列表
     *
     * @return
     */
    @RequestMapping(value = "/getbmblsl", method = RequestMethod.GET)
    public Map<String, Object> getbmblsl(@RequestParam(value = "year", required = true) String year,
                                         @RequestParam(value = "month", required = true) String month,
                                         @RequestParam(value = "day", required = true) String day,
                                         @RequestParam(value = "page", required = true) String page) {
        Map<String, Object> map = new HashMap<String, Object>();
        List<Map<String, Object>> list = tyslService.getbmblsl(year, month, day, page);
        System.out.println("bmsl========" + list);
        map.put("bmsl", list);
        return map;
    }

    /**
     * 下载各业务处室一窗办理数量
     *
     * @return
     */
    @RequestMapping(value = "/downloadbmblsl", method = RequestMethod.GET)
    public void downloadbmblsl(@RequestParam(value = "year", required = true) String year,
                               @RequestParam(value = "month", required = true) String month,
                               @RequestParam(value = "day", required = true) String day,
                               HttpServletResponse response) {
        File file = null;
        try {
            file = ResourceUtils.getFile("classpath:static/excel/各业务处室办理数量.xlsx");
            //查询数据
            List<Map<String, Object>> list = tyslService.downloadbmblsl(year, month, day, "");
            //System.out.println(list);
            // 往excel里写入数据
            TemplateExportExcelUtil.exportExcel(file, list, response);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
    }

    /**
     * // 获取短信评价的信息
     *
     * @return
     */
    @RequestMapping(value = "/getwspjxx", method = RequestMethod.GET)
    public Map<String, Object> getwspjxx() {
        Map<String, Object> map = new HashMap<String, Object>();
        Date now = new Date();    //创建一个Date对象,获取当前时间
        //指定格式化格式
        SimpleDateFormat f = new SimpleDateFormat("yyyy-MM");
        String Cdate = f.format(now);
        System.out.println("Cdate=============="+Cdate);
        // 获取网上评价的信息 scoreType 1是满意 2是基本满意 3是不满意
        List<Map<String, Object>> list = dzjcService.getwspjxx();
        // 获取短信评价的信息 replay 1是满意 2是基本满意 3是不满意
        List<Map<String, Object>> lists = dtglService.getdxpjxx(Cdate);

        System.out.println("list========" + list);
        System.out.println("lists========" + lists);
        map.put("wspj", list);
        map.put("dxpj", lists);
        return map;
    }


    /**
     * // 获取窗口人员办件情况
     *
     * @return
     */
    @RequestMapping(value = "/getckrybjqk", method = RequestMethod.GET)
    public Map<String, Object> getckrybjqk(@RequestParam(value = "year", required = true) String year,
                                           @RequestParam(value = "month", required = true) String month,
                                           @RequestParam(value = "day", required = true) String day,
                                           @RequestParam(value = "page", required = true) String page) {
        Map<String, Object> map = new HashMap<String, Object>();
        List<Map<String, Object>> list = tyslService .getckrybjqk(year,month,day,page);
        System.out.println("ckrybjqk========="+list);
        map.put("ckrybjqk", list);
        return map;
    }


    /**
     * // 获取窗口人员办件情况
     *
     * @return
     */
    @RequestMapping(value = "/getckfycx", method = RequestMethod.GET)
    public Map<String, Object> getckfycx(@RequestParam(value = "year", required = true) String year,
                                         @RequestParam(value = "month", required = true) String month,
                                         @RequestParam(value = "day", required = true) String day,
                                         @RequestParam(value = "page", required = true) String page,HttpServletRequest request) {
        String pagess = request.getParameter("pagess");
        int num =  Integer.parseInt(pagess);
        Map<String, Object> map = new HashMap<String, Object>();
        if (page == null) {
            PageHelper.startPage(0, 10);
        } else {
            PageHelper.startPage(num, 10);
        }
        List<Map<String, Object>> list = tyslService .getckrybjqk(year,month,day,page);
        PageInfo pageInfo = new PageInfo(list);
        System.out.println("pageInfo========="+pageInfo);
        map.put("ckrybjqk", pageInfo);
        return map;
    }
}

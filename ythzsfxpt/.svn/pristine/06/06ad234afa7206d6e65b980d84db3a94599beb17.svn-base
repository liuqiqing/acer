package com.inspur.controller;

import com.inspur.service.TyslService;
import com.inspur.utils.TemplateExportExcelUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.ResourceUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.FileNotFoundException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/* 一窗受理controller
 * @author ly
 * @date 20191030
 *
 */
@RestController
@RequestMapping("/tyslcontroller")
public class TyslController {

    @Autowired
    private TyslService tyslService;

    @RequestMapping(value = "/tyslsum", method = RequestMethod.GET)
    public Map<String, Object> tyslsum() {
        Map<String, Object> map = new HashMap<String, Object>();
        int tyslsum = tyslService.getSum();
        System.out.println("tyslsum========" + tyslsum);
        map.put("tyslsum", tyslsum);
        return map;
    }

    /**
     *
     * 获取每天的一窗受理数量
     *
     * @return
     */
    @RequestMapping(value = "/getycsjsl", method = RequestMethod.GET)
    public Map<String, Object> getycsjsl() {
        Map<String, Object> map = new HashMap<String, Object>();
        Date now = new Date();    //创建一个Date对象，获取当前时间
        //指定格式化格式
        SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");
        String Cdate = f.format(now);
        System.out.println("Cdate======" + Cdate);
        List<Map<String, Object>> ycsjsl = tyslService.getycsjsl(Cdate);
        System.out.println("ycsjsl========" + ycsjsl);
        int sum = 0;
        for (int i = 0; i <ycsjsl.size() ; i++) {
            System.out.println(ycsjsl.get(i));
            sum += Integer.parseInt(ycsjsl.get(i).get("SUM").toString());
        }
        System.out.println("tyslsum========" + sum);
        map.put("ycsjsl", sum);
        return map;
    }

    /**
     *
     * 获取一窗收件数量变化趋势
     *
     * @return
     */
    @RequestMapping(value = "/getycsjqs", method = RequestMethod.GET)
    public Map<String, Object> getycsjqs() {
        Map<String, Object> map = new HashMap<String, Object>();
        List<Map<String,Object>> list = tyslService.getycsjqs();
        System.out.println("tyslsum========" + list);
        map.put("ycsjqs", list);
        return map;
    }

    /**
     *
     * 获取一窗收件事项列表
     *
     * @return
     */
    @RequestMapping(value = "/getycsjlb", method = RequestMethod.GET)
    public Map<String, Object> getycsjlb(@RequestParam(value = "page", required = true) int page) {
        Map<String, Object> map = new HashMap<String, Object>();
        Date now = new Date();    //创建一个Date对象，获取当前时间
        //指定格式化格式
        SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");
        String Cdate = f.format(now);
        System.out.println("Cdate======" + Cdate);
        List<Map<String,Object>> list = tyslService.getycsjlb(Cdate,page);
        System.out.println("ycsjlb========" + list);
        map.put("ycsjlb", list);
        return map;
    }

    /**
     *
     * 下载一窗收件事项列表
     *
     * @return
     */
    @RequestMapping(value = "/downloadsxlb", method = RequestMethod.GET)
    public void downloadsxlb(HttpServletResponse response) {
        File file = null;
        try {
            file = ResourceUtils.getFile("classpath:static/excel/一窗事项列表.xlsx");
            Date now = new Date();    //创建一个Date对象，获取当前时间
            //指定格式化格式
            SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd");
            String Cdate = f.format(now);
            //查询数据
            List<Map<String, Object>> list = tyslService.downloadsxlb(Cdate);
            // 往excel里写入数据
            TemplateExportExcelUtil.exportExcel(file, list, response);

        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
    }
}
